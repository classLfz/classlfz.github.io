<!DOCTYPE html>
<html lang="zh-Hans">
<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="classlfz">


    <meta name="subtitle" content="轻舟已过万重山">


    <meta name="description" content="classlfz blog 博客 主页">


    <meta name="keywords" content="classlfz 前端 摄影">


<title>使用原生JS编写一个图片裁剪器 | classlfz的笔记本</title>



    <link rel="icon" href="/favicon.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


<meta name="generator" content="Hexo 4.1.1"></head>
<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">classlfz的笔记本</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>

        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">classlfz的笔记本</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/category">Categories</a>
                
                    <a class="menu-item" href="/tag">Tags</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
        <div class="main">
            <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "Collapse all"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "Expand all"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">使用原生JS编写一个图片裁剪器</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">classlfz</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">July 23, 2017&nbsp;&nbsp;22:35:00</a>
                        </span>
                    
                    
                        <span class="post-category">
                    Category:
                            
                                <a href="/categories/web%E5%89%8D%E7%AB%AF/">web前端</a>
                            
                        </span>
                    
                </div>
            
        </header>

        <div class="post-content">
            <blockquote>
<p>作为一个前端开发人员，这次的这篇博客文章终于“正常”了。</p>
</blockquote>
<p>这应该算是一个造轮子的实践，JS的图片开源裁剪器有很多，像使用JQuery库编写的<code>cropper</code>插件很多，在github上边的star数量也不少，现流行的前端框架也肯定有对应的图片裁剪器，都是可以选择的成熟的技术方案。但不是所有的情况都能适用，设计师的要求，本身项目的条件限制等等原因，有些时候，还是“自己动手，丰衣足食”啊！</p>
<p><strong>因为用到了很多<code>html5</code>的特性，所以，这里编写的图片裁剪器，只能是适合于支持这些HTML5特性的浏览器才能够正常的使用。</strong></p>
<h2 id="需求描述"><a href="#需求描述" class="headerlink" title="需求描述"></a>需求描述</h2><ul>
<li><p>点击按钮选择图片，并进行展示；</p>
</li>
<li><p>展示区有一个正方形裁剪区，图片可以放大缩小；</p>
</li>
<li><p>在展示区，点击鼠标后拖拽，可对图片的位置进行调试，但展示图片不能越过裁剪区；</p>
</li>
<li><p>点击裁剪按钮，对位于裁剪区的图片进行裁剪，并展示裁剪后的图片；</p>
</li>
</ul>
<h2 id="HTML-amp-CSS部分"><a href="#HTML-amp-CSS部分" class="headerlink" title="HTML &amp; CSS部分"></a>HTML &amp; CSS部分</h2><p>首先，我们要编写一些基础的HTML代码：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"scissorsContainer"</span>&gt;</span> </span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"imageInput"</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">hidden</span> <span class="attr">onchange</span>=<span class="string">"ImageInputChanged(event)"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">label</span> <span class="attr">class</span>=<span class="string">"btn"</span> <span class="attr">for</span>=<span class="string">"imageInput"</span>&gt;</span>SELECT IMAGE<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"workArea"</span> <span class="attr">onmousedown</span>=<span class="string">"startDrag(event)"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"overlay"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"overlayInner"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">img</span> <span class="attr">id</span>=<span class="string">"avatorImg"</span> <span class="attr">onload</span>=<span class="string">"avatorImgChanged()"</span> <span class="attr">alt</span>=<span class="string">""</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"resizeBox"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">"btn"</span> <span class="attr">onclick</span>=<span class="string">"resizeDown()"</span>&gt;</span>缩小<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">"btn"</span> <span class="attr">onclick</span>=<span class="string">"resizeUp()"</span>&gt;</span>放大<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">"btn"</span> <span class="attr">onclick</span>=<span class="string">"crop()"</span>&gt;</span>CROP<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h4</span>&gt;</span>Image Show<span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">id</span>=<span class="string">"imageShow"</span> <span class="attr">src</span>=<span class="string">""</span> <span class="attr">alt</span>=<span class="string">""</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>添加样式。我这里是用了flex布局，如果不想用flex布局的话，可以选择其他的布局方式。</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">body</span> &#123;</span><br><span class="line">  <span class="attribute">display</span>: flex;</span><br><span class="line">  <span class="attribute">justify-content</span>: center;</span><br><span class="line">  <span class="attribute">flex-direction</span>: column;</span><br><span class="line">  <span class="attribute">align-items</span>: center;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-id">#scissorsContainer</span> &#123;</span><br><span class="line">  <span class="attribute">display</span>: flex;</span><br><span class="line">  <span class="attribute">justify-content</span>: center;</span><br><span class="line">  <span class="attribute">flex-direction</span>: column;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.btn</span> &#123;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">8px</span>;</span><br><span class="line">  <span class="attribute">font-size</span>: <span class="number">14px</span>;</span><br><span class="line">  <span class="attribute">border</span>: <span class="number">1px</span> solid <span class="number">#1976d2</span>;</span><br><span class="line">  <span class="attribute">border-radius</span>: <span class="number">2px</span>;</span><br><span class="line">  <span class="attribute">background</span>: <span class="number">#ffffff</span>;</span><br><span class="line">  <span class="attribute">text-align</span>: center;</span><br><span class="line">  <span class="attribute">cursor</span>: pointer;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.btn</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="number">#1976d2</span>;</span><br><span class="line">  <span class="attribute">color</span>: <span class="number">#ffffff</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-id">#workArea</span> &#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">500px</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">500px</span>;</span><br><span class="line">  <span class="attribute">position</span>: relative;</span><br><span class="line">  <span class="attribute">margin</span>: <span class="number">16px</span> <span class="number">0</span>;</span><br><span class="line">  <span class="attribute">overflow</span>: hidden;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-id">#overlay</span> &#123;</span><br><span class="line">  <span class="attribute">position</span>: absolute;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">100%</span>;</span><br><span class="line">  <span class="attribute">background</span>: <span class="number">#eeeeee</span>;</span><br><span class="line">  <span class="attribute">display</span>: flex;</span><br><span class="line">  <span class="attribute">justify-content</span>: center;</span><br><span class="line">  <span class="attribute">align-items</span>: center;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-id">#overlayInner</span> &#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">300px</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">300px</span>;</span><br><span class="line">  <span class="attribute">border</span>: <span class="number">100px</span> solid gray;</span><br><span class="line">  <span class="attribute">opacity</span>: <span class="number">0.7</span>;</span><br><span class="line">  <span class="attribute">z-index</span>: <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-id">#avatorImg</span> &#123;</span><br><span class="line">  <span class="attribute">width</span>: auto;</span><br><span class="line">  <span class="attribute">height</span>: auto;</span><br><span class="line">  <span class="attribute">border</span>: none;</span><br><span class="line">  <span class="attribute">outline</span>: none;</span><br><span class="line">  <span class="attribute">position</span>: absolute;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-id">#resizeBox</span> &#123;</span><br><span class="line">  <span class="attribute">display</span>: flex;</span><br><span class="line">  <span class="attribute">justify-content</span>: center;</span><br><span class="line">  <span class="attribute">align-items</span>: center;</span><br><span class="line">  <span class="attribute">margin-bottom</span>: <span class="number">16px</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-id">#resizeBox</span> &gt; <span class="selector-tag">div</span> &gt; <span class="selector-tag">button</span> &#123;</span><br><span class="line">  <span class="attribute">margin</span>: <span class="number">0</span> <span class="number">8px</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-id">#imageShow</span> &#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">300px</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">300px</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="设置全局变量"><a href="#设置全局变量" class="headerlink" title="设置全局变量"></a>设置全局变量</h2><p>这里，我们设置一些JS代码里边需要的全局变量，具体的作用，下边的部分我们会介绍到的。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// *** 定义全局变量 ***</span></span><br><span class="line">  <span class="comment">// 全局需要的元素</span></span><br><span class="line">  <span class="built_in">window</span>.workArea = <span class="built_in">document</span>.querySelector(<span class="string">'#workArea'</span>);</span><br><span class="line">  <span class="built_in">window</span>.avatorImg = <span class="built_in">document</span>.querySelector(<span class="string">'#avatorImg'</span>);</span><br><span class="line">  <span class="built_in">window</span>.imageShow = <span class="built_in">document</span>.querySelector(<span class="string">'#imageShow'</span>);</span><br><span class="line">  <span class="comment">// 鼠标初始位置坐标数值</span></span><br><span class="line">  <span class="built_in">window</span>.mouseStartX = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">window</span>.mouseStartY = <span class="number">0</span>;</span><br><span class="line">  <span class="comment">// 图片初始化后的尺寸记录</span></span><br><span class="line">  <span class="built_in">window</span>.initLength = &#123;</span><br><span class="line">    width: <span class="number">0</span>,</span><br><span class="line">    height: <span class="number">0</span></span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// 图片原始尺寸记录</span></span><br><span class="line">  <span class="built_in">window</span>.primitiveLength = &#123;</span><br><span class="line">    width: <span class="number">0</span>,</span><br><span class="line">    height: <span class="number">0</span></span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// 图片放大缩小的数值</span></span><br><span class="line">  <span class="built_in">window</span>.resizeValue = <span class="number">0</span>;</span><br><span class="line">  <span class="comment">// 图片呈现高度&amp;宽度，需要根据HTML以及CSS部分的overlayInner的高宽度一致</span></span><br><span class="line">  <span class="built_in">window</span>.showSide = <span class="built_in">document</span>.querySelector(<span class="string">'#overlayInner'</span>).clientWidth;</span><br><span class="line">  <span class="comment">// 裁剪的图片类型</span></span><br><span class="line">  <span class="built_in">window</span>.croppedImageType = <span class="string">'image/png'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="获取图片数据，并展示"><a href="#获取图片数据，并展示" class="headerlink" title="获取图片数据，并展示"></a>获取图片数据，并展示</h2><p>我们在上边的HTML部分写了一个隐藏的<code>input[type=&quot;file&quot;]</code>，通过一个<code>label</code>标签来触发它，同时监听这个<code>input</code>元素，当它的值发生改变时，可以通过一个<code>FileReader</code>的对象获取到这个<code>input</code>的数据，并将它转换成<code>base64</code>格式的数据。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 图片选择元素的值发生变化后，重置图片裁剪区的样式</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param <span class="type">&#123;Object&#125;</span> </span>e input数值变化事件</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ImageInputChanged</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> file = e.target.files[<span class="number">0</span>];</span><br><span class="line">  <span class="keyword">var</span> reader = <span class="keyword">new</span> FileReader();</span><br><span class="line">  reader.onload = <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 赋值给图片展示元素</span></span><br><span class="line">    avatorImg.src = event.target.result;</span><br><span class="line">    <span class="comment">// 重置样式</span></span><br><span class="line">    avatorImg.style.width = <span class="string">'auto'</span>;</span><br><span class="line">    avatorImg.style.height = <span class="string">'auto'</span>;</span><br><span class="line">    avatorImg.style.top = <span class="string">'auto'</span>;</span><br><span class="line">    avatorImg.style.left = <span class="string">'auto'</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  reader.readAsDataURL(file);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="图片展示区的数据发生变化"><a href="#图片展示区的数据发生变化" class="headerlink" title="图片展示区的数据发生变化"></a>图片展示区的数据发生变化</h2><p>图片展示区的数据发生变化，我们在这里除了收集图片的原始信息以外，还对图片进行了初始化的像素调整。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">avatorImgChanged</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (avatorImg.offsetWidth &gt;= avatorImg.offsetHeight) &#123;</span><br><span class="line">    avatorImg.style.top = <span class="string">'100px'</span>;</span><br><span class="line">    initLength.width = showSide * avatorImg.offsetWidth / avatorImg.offsetHeight</span><br><span class="line">    initLength.height = showSide;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    avator.style.left = <span class="string">'100px'</span>;</span><br><span class="line">    initLength.height = showSide * avatorImg.offsetWidth / avatorImg.offsetWidth;</span><br><span class="line">    initLength.width = showSide;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 保存新的图片原始像素值</span></span><br><span class="line">  primitiveLength = &#123;</span><br><span class="line">    width: avatorImg.offsetWidth,</span><br><span class="line">    height: avatorImg.offsetHeight</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// 更新图片样式</span></span><br><span class="line">  avatorImg.style.width = initLength.width + <span class="string">'px'</span>;</span><br><span class="line">  avatorImg.style.height = initLength.height + <span class="string">'px'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="图片的放大与缩小"><a href="#图片的放大与缩小" class="headerlink" title="图片的放大与缩小"></a>图片的放大与缩小</h2><p>在上边对应的HTML部分，我们添加了图片放大与缩小的按钮。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 图片放大</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resizeUp</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (resizeValue &lt;= <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">  resizeValue += <span class="number">10</span>;</span><br><span class="line">  resize();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 图片缩小</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resizeDown</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  resizeValue -= <span class="number">10</span>;</span><br><span class="line">  resize();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 修改图片比例大小</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resize</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  avatorImg.style.width = (resizeValue + <span class="number">100</span>) / <span class="number">100</span> * initLength.width + <span class="string">'px'</span>;</span><br><span class="line">  avatorImg.style.height = (resizeValue + <span class="number">100</span>) / <span class="number">100</span> * initLength.height + <span class="string">'px'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="图片的拖拽"><a href="#图片的拖拽" class="headerlink" title="图片的拖拽"></a>图片的拖拽</h2><p>图片的拖拽，就是利用鼠标的三个事件来完成——<code>mousedown</code>，<code>mousemove</code>以及<code>mouseup</code>。我们在<code>mousedown</code>的时候，记录鼠标的初始位置，添加<code>mousemove</code>以及<code>mouseup</code>事件监听函数。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 监测鼠标点击，开始拖拽</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param <span class="type">&#123;Object&#125;</span> </span>e 鼠标点击事件</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">startDrag</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">  e.preventDefault();</span><br><span class="line">  <span class="keyword">if</span> (avatorImg.src) &#123;</span><br><span class="line">    <span class="comment">// 记录鼠标初始位置</span></span><br><span class="line">    <span class="built_in">window</span>.mouseStartX = e.clientX;</span><br><span class="line">    <span class="built_in">window</span>.mouseStartY = e.clientY;</span><br><span class="line">    <span class="comment">// 添加鼠标移动以及鼠标点击松开事件监听</span></span><br><span class="line">    workArea.addEventListener(<span class="string">'mousemove'</span>, <span class="built_in">window</span>.dragging, <span class="literal">false</span>);</span><br><span class="line">    workArea.addEventListener(<span class="string">'mouseup'</span>, <span class="built_in">window</span>.clearDragEvent, <span class="literal">false</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>图片的拖拽，我们这里做了一些限制，限制不让它拖拽出裁剪区。这主要是防止我们裁剪出不属于原图的空白区域。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 处理拖拽</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param <span class="type">&#123;Object&#125;</span> </span>e 鼠标移动事件</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">dragging</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// *** 图片不存在 ***</span></span><br><span class="line">  <span class="keyword">if</span> (!avatorImg.src) <span class="keyword">return</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// *** 图片存在 ***</span></span><br><span class="line">  <span class="comment">// X轴</span></span><br><span class="line">  <span class="keyword">let</span> _moveX = avatorImg.offsetLeft + e.clientX - mouseStartX;</span><br><span class="line">  <span class="comment">// 这里的100是HTML里边overlayInner的border属性的宽度</span></span><br><span class="line">  <span class="comment">// 下边的400就是overlayInner元素的边长加上border的宽度之和</span></span><br><span class="line">  <span class="keyword">if</span> (_moveX &gt;= <span class="number">100</span>) &#123;</span><br><span class="line">    avatorImg.style.left = <span class="string">'100px'</span>;</span><br><span class="line">    mouseStartX = e.clientX;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (_moveX &lt;= <span class="number">400</span> - avatorImg.offsetWidth) &#123;</span><br><span class="line">    _moveX = <span class="number">400</span> - avatorImg.offsetWidth;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  avatorImg.style.left = _moveX + <span class="string">'px'</span>;</span><br><span class="line">  mouseStartX = e.clientX;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Y轴</span></span><br><span class="line">  <span class="keyword">let</span> _moveY = avatorImg.offsetTop + e.clientY - mouseStartY;</span><br><span class="line">  <span class="keyword">if</span> (_moveY &gt;= <span class="number">100</span>) &#123;</span><br><span class="line">    avatorImg.style.top = <span class="string">'100px'</span>;</span><br><span class="line">    mouseStartY = e.clientY;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (_moveY &lt;= <span class="number">400</span> - avatorImg.offsetHeight) &#123;</span><br><span class="line">    _moveY = <span class="number">400</span> - avatorImg.offsetHeight;</span><br><span class="line">  &#125;</span><br><span class="line">  avatorImg.style.top = _moveY + <span class="string">'px'</span>;</span><br><span class="line">  mouseStartY = e.clientY;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="裁剪"><a href="#裁剪" class="headerlink" title="裁剪"></a>裁剪</h2><p>最后，我们利用HTML5的canvas元素具有的<a href="https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/drawImage" target="_blank" rel="noopener"><code>ctx.drawImage(image, sx, sy, sWidth, sHeight, dx, dy, dWidth, dHeight);</code></a>方法，描绘出位于裁剪区的图片信息。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 对图片进行裁剪</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">crop</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!avatorImg.src) <span class="keyword">return</span>;</span><br><span class="line">  <span class="keyword">let</span> _cropCanvas = <span class="built_in">document</span>.createElement(<span class="string">'canvas'</span>);</span><br><span class="line">  <span class="comment">// 计算边长</span></span><br><span class="line">  <span class="keyword">let</span> _side = (showSide / avatorImg.offsetWidth) * primitiveLength.width;</span><br><span class="line">  _cropCanvas.width = _side;</span><br><span class="line">  _cropCanvas.height = _side;</span><br><span class="line">  <span class="comment">// 计算截取时从原图片的原始长度的坐标</span></span><br><span class="line">  <span class="comment">// 因为图片有可能会被放大/缩小，这时候，初始化时记录下来的primitiveLength信息就有用处了</span></span><br><span class="line">  <span class="keyword">let</span> _sy = (<span class="number">100</span> - avatorImg.offsetTop) / avatorImg.offsetHeight * primitiveLength.height;</span><br><span class="line">  <span class="keyword">let</span> _sx = (<span class="number">100</span> - avatorImg.offsetLeft) / avatorImg.offsetWidth * primitiveLength.width;</span><br><span class="line">  <span class="comment">// 绘制图片</span></span><br><span class="line">  _cropCanvas.getContext(<span class="string">'2d'</span>).drawImage(avatorImg, _sx, _sy, _side, _side, <span class="number">0</span>, <span class="number">0</span>, _side, _side);</span><br><span class="line">  <span class="comment">// 保存图片信息</span></span><br><span class="line">  <span class="keyword">let</span> _lastImageData = _cropCanvas.toDataURL(croppedImageType);</span><br><span class="line">  <span class="comment">// 将裁剪出来的信息展示</span></span><br><span class="line">  imageShow.src = _lastImageData;</span><br><span class="line">  imageShow.style.width = showSide + <span class="string">'px'</span>;</span><br><span class="line">  imageShow.style.height = showSide + <span class="string">'px'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h2><p><a href="https://github.com/classLfz/my-blog/blob/master/examples/write-an-image-scissors.html" target="_blank" rel="noopener">查看完整代码</a></p>

        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>classlfz</span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>Permalink:</span>
                        <span><a href="http://classlfz.github.io/2017/07/23/write-an-image-scissors/">http://classlfz.github.io/2017/07/23/write-an-image-scissors/</a></span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2019 <a href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                
                     <p class="copyright-item">
                         <span>Slogan:</span>
                         <span>去他妈的工作！</span>
                     </p>
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tags/web%E5%89%8D%E7%AB%AF/"># web前端</a>
                    
                        <a href="/tags/canvas/"># canvas</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2017/08/12/my-toys/">玩具总动员</a>
            
            
            <a class="next" rel="next" href="/2017/07/01/something-to-talk/">我的博客</a>
            
        </section>


    </article>
</div>

        </div>
        <footer id="footer" class="footer">
    <div class="copyright">
        <span>© classlfz | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>

    </div>
</body>
</html>
